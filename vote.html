<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>å°åŒºåŒ…é˜³å°æ–¹æ¡ˆæŠ•ç¥¨ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
    <style>
        * { 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        body { 
            max-width: 100%; 
            margin: 0; 
            padding: 15px; 
            background: #f5f7fa; 
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 6px 16px rgba(0,0,0,0.08); 
            padding: 25px; 
            margin-bottom: 20px; 
            position: relative;
            overflow: hidden;
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin: 10px 0 20px;
            font-size: 1.5rem;
        }
        .step { 
            display: none; 
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .active { display: block; }
        input, button, .btn { 
            padding: 14px 18px; 
            width: 100%; 
            margin: 12px 0; 
            border: 1px solid #e1e5e9; 
            border-radius: 12px; 
            font-size: 16px; 
            outline: none;
            transition: all 0.2s;
        }
        input {
            background: #f9fbfd;
        }
        input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        button, .btn { 
            background: #3498db; 
            color: white; 
            font-weight: 600; 
            border: none; 
            cursor: pointer; 
            text-align: center;
            display: block;
            letter-spacing: 0.5px;
            font-size: 17px;
        }
        button:hover, .btn:hover { 
            background: #2980b9; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .option { 
            display: flex; 
            align-items: center; 
            padding: 18px 20px; 
            border: 2px solid #edf2f7; 
            border-radius: 14px; 
            margin: 15px 0; 
            cursor: pointer; 
            transition: all 0.2s;
            background: #fcfdff;
        }
        .option:hover { 
            border-color: #3498db; 
            background: #f8fafd; 
        }
        .option.selected { 
            border-color: #3498db; 
            background: #e1f0fa; 
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.15);
        }
        .radio { 
            width: 24px; 
            height: 24px; 
            border: 2px solid #95a5a6; 
            border-radius: 50%; 
            margin-right: 18px; 
            position: relative; 
            flex-shrink: 0;
        }
        .radio:after { 
            content: ""; 
            position: absolute; 
            width: 14px; 
            height: 14px; 
            background: #3498db; 
            border-radius: 50%; 
            top: 3px; 
            left: 3px; 
            display: none; 
        }
        .selected .radio:after { display: block; }
        .result-bar { 
            height: 30px; 
            background: #ecf0f1; 
            border-radius: 15px; 
            margin: 18px 0; 
            overflow: hidden; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .fill { 
            height: 100%; 
            border-radius: 15px; 
            text-align: center; 
            color: white; 
            font-weight: bold; 
            font-size: 14px;
            line-height: 30px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            transition: width 0.8s ease;
        }
        .success { background: linear-gradient(90deg, #2ecc71, #1abc9c); }
        .danger { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .info { background: linear-gradient(90deg, #3498db, #2980b9); }
        .error-msg { 
            color: #e74c3c; 
            font-size: 14px; 
            margin-top: -8px; 
            margin-bottom: 10px;
            display: none;
        }
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 10px auto 20px;
            display: block;
            color: #2ecc71;
        }
        .footer {
            text-align: center;
            color: #95a5a6;
            font-size: 13px;
            padding: 20px 0;
        }
        .admin-link {
            display: block;
            text-align: center;
            color: #3498db;
            text-decoration: none;
            margin: 15px 0;
            font-weight: 500;
        }
        .qr-container {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: #f8fafd;
            border-radius: 16px;
        }
        .qr-code {
            width: 180px;
            height: 180px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qr-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 12px;
        }
        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        .share-btn {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            color: white;
            flex: 1;
            max-width: 120px;
        }
        .share-btn.wechat {
            background: #07c160;
        }
        .share-btn.copy {
            background: #3498db;
        }
        .share-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .deploy-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #856404;
        }
        .deploy-notice h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        .deploy-notice ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .deploy-notice li {
            margin: 5px 0;
        }
        .reset-btn {
            background: #e74c3c;
            margin-top: 10px;
        }
        @media (max-width: 480px) {
            body { padding: 12px; }
            .card { padding: 20px 18px; }
            h1 { font-size: 1.4rem; }
            .option { padding: 16px; }
            .share-buttons {
                flex-direction: column;
                align-items: center;
            }
            .share-btn {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 id="voteTitle">å°åŒºåŒ…é˜³å°æ–¹æ¡ˆæŠ•ç¥¨</h1>
            
            <!-- éƒ¨ç½²è¯´æ˜ -->
            <div class="deploy-notice">
                <h4>ğŸ“± å¾®ä¿¡åˆ†äº«è¯´æ˜</h4>
                <p>ä¸ºäº†è®©å¾®ä¿¡æ‰«æäºŒç»´ç èƒ½æ­£å¸¸æ‰“å¼€æŠ•ç¥¨é¡µé¢ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
                <ul>
                    <li><strong>æ–¹æ³•1ï¼š</strong> å°†HTMLæ–‡ä»¶ä¸Šä¼ åˆ°ç½‘ç»œæœåŠ¡å™¨ï¼ˆå¦‚GitHub Pagesã€Vercelç­‰ï¼‰</li>
                    <li><strong>æ–¹æ³•2ï¼š</strong> ä½¿ç”¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢ï¼Œç„¶ååˆ†äº«åˆ°å¾®ä¿¡ç¾¤</li>
                    <li><strong>æ–¹æ³•3ï¼š</strong> ç‚¹å‡»ä¸‹æ–¹"å¤åˆ¶é“¾æ¥"æŒ‰é’®ï¼Œå°†é“¾æ¥å‘é€åˆ°å¾®ä¿¡ç¾¤</li>
                </ul>
            </div>
            
            <!-- æ­¥éª¤1: é—¨ç‰Œå·éªŒè¯ -->
            <div id="step1" class="step active">
                <p>è¯·è¾“å…¥æ‚¨çš„é—¨ç‰Œå·ï¼š</p>
                <input type="text" id="houseInput" placeholder="ä¾‹å¦‚: 1-502, 4-1-802, 7-202">
                <p id="errorMsg" class="error-msg">é—¨ç‰Œå·æ— æ•ˆæˆ–ä¸å­˜åœ¨</p>
                <button onclick="verifyHouse()">éªŒè¯é—¨ç‰Œå·</button>
                
                <div class="qr-container">
                    <div class="qr-code" id="qrCode"></div>
                    <p class="qr-text">æ‰‹æœºæ‰«ç åˆ†äº«æŠ•ç¥¨</p>
                    <div class="share-buttons">
                        <button class="share-btn wechat" onclick="shareToWechat()">åˆ†äº«åˆ°å¾®ä¿¡</button>
                        <button class="share-btn copy" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤2: æŠ•ç¥¨é€‰æ‹© -->
            <div id="step2" class="step">
                <p>è¯·é€‰æ‹©æ‚¨çš„æŠ•ç¥¨ï¼š</p>
                <div class="option" onclick="selectOption(0)">
                    <div class="radio"></div>
                    <span>åŒæ„åŒ…é˜³å°æ–¹æ¡ˆ</span>
                </div>
                <div class="option" onclick="selectOption(1)">
                    <div class="radio"></div>
                    <span>åå¯¹åŒ…é˜³å°æ–¹æ¡ˆ</span>
                </div>
                <div class="option" onclick="selectOption(2)">
                    <div class="radio"></div>
                    <span>å¼ƒæƒ</span>
                </div>
                <button onclick="submitVote()">æäº¤æŠ•ç¥¨</button>
                <a href="#" class="admin-link" onclick="showAdmin()">ç®¡ç†å‘˜å…¥å£</a>
            </div>
            
            <!-- æ­¥éª¤3: æŠ•ç¥¨ç¡®è®¤ -->
            <div id="step3" class="step">
                <svg class="success-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
                </svg>
                <h2 style="text-align:center; color:#2c3e50;">æŠ•ç¥¨æˆåŠŸï¼</h2>
                <p style="text-align:center;" id="voteResult"></p>
                <button class="btn" onclick="location.reload()">è¿”å›é¦–é¡µ</button>
                <a href="#" class="admin-link" onclick="showAdmin()">æŸ¥çœ‹ç»Ÿè®¡ç»“æœ</a>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜é¢æ¿ -->
        <div id="adminPanel" class="card" style="display:none;">
            <h2>æŠ•ç¥¨ç®¡ç†ç³»ç»Ÿ</h2>
            <p><input type="password" id="adminPass" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç "></p>
            <button onclick="loadStats()">æŸ¥çœ‹ç»Ÿè®¡</button>
            
            <div id="stats" style="display:none; margin-top:30px;">
                <div style="display:flex; justify-content:space-between; gap:15px;">
                    <div style="text-align:center; flex:1; background:#f8fafd; padding:15px; border-radius:12px;">
                        <div style="font-size:28px; font-weight:bold; color:#2c3e50;" id="totalHouses">0</div>
                        <div style="color:#7f8c8d; margin-top:5px;">æ€»æˆ·æ•°</div>
                    </div>
                    <div style="text-align:center; flex:1; background:#f8fafd; padding:15px; border-radius:12px;">
                        <div style="font-size:28px; font-weight:bold; color:#3498db;" id="votedHouses">0</div>
                        <div style="color:#7f8c8d; margin-top:5px;">å·²æŠ•ç¥¨</div>
                    </div>
                    <div style="text-align:center; flex:1; background:#f8fafd; padding:15px; border-radius:12px;">
                        <div style="font-size:28px; font-weight:bold; color:#2ecc71;" id="voteRatio">0%</div>
                        <div style="color:#7f8c8d; margin-top:5px;">å‚ä¸ç‡</div>
                    </div>
                </div>
                
                <h3 style="margin-top:30px; color:#2c3e50;">æŠ•ç¥¨åˆ†å¸ƒ</h3>
                <div id="agreeStats" style="margin-bottom:25px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>åŒæ„</span>
                        <span><span id="agreeCount">0</span> (<span id="agreePercent">0%</span>)</span>
                    </div>
                    <div class="result-bar"><div class="fill success" style="width:0%"></div></div>
                </div>
                <div id="disagreeStats" style="margin-bottom:25px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>åå¯¹</span>
                        <span><span id="disagreeCount">0</span> (<span id="disagreePercent">0%</span>)</span>
                    </div>
                    <div class="result-bar"><div class="fill danger" style="width:0%"></div></div>
                </div>
                <div id="abstainStats">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>å¼ƒæƒ</span>
                        <span><span id="abstainCount">0</span> (<span id="abstainPercent">0%</span>)</span>
                    </div>
                    <div class="result-bar"><div class="fill info" style="width:0%"></div></div>
                </div>
                
                <h3 style="margin-top:30px; color:#2c3e50;">æŠ•ç¥¨ç»“æœ</h3>
                <div id="finalResult" style="padding:20px; background:#f8f9fa; border-radius:12px; text-align:center; font-size:18px; font-weight:bold; margin:20px 0;">
                    - ç­‰å¾…ç»Ÿè®¡ -
                </div>
                
                <h3 style="margin-top:30px; color:#2c3e50;">å•æˆ·é‡ç½®</h3>
                <p>é‡ç½®æŒ‡å®šé—¨ç‰Œå·çš„æŠ•ç¥¨ï¼š</p>
                <input type="text" id="resetHouseInput" placeholder="è¾“å…¥è¦é‡ç½®çš„é—¨ç‰Œå·">
                <button class="reset-btn" onclick="resetSingleVote()">é‡ç½®è¯¥æˆ·æŠ•ç¥¨</button>
                
                <button onclick="exportData()" style="background:#27ae60; margin-top:20px;">å¯¼å‡ºæŠ•ç¥¨æ•°æ®</button>
                <button onclick="resetVotes()" style="background:#e74c3c; margin-top:10px;">é‡ç½®å…¨éƒ¨æŠ•ç¥¨</button>
            </div>
        </div>
        
        <div class="footer">
            <p>å°åŒºåŒ…é˜³å°æ–¹æ¡ˆæŠ•ç¥¨ç³»ç»Ÿ &copy; 2025</p>
            <p>å°‘æ•°æœä»å¤šæ•°åŸåˆ™ | æ¯æˆ·ä¸€ç¥¨</p>
        </div>
    </div>

    <script>
        // é—¨ç‰Œå·æ•°æ®ï¼ˆä»Excelæå–ï¼‰
        const validHouses = [
            "1-201","1-202","1-301","1-302","1-401","1-402","1-501","1-502","1-601","1-602",
            "1-701","1-702","1-801","1-802","1-901","1-902","1-1001","1-1002","1-1101","1-1102",
            "1-1201","1-1202","1-1301","1-1302","1-1401","1-1402","1-1501","1-1502","1-1601","1-1602",
            "1-1701","1-1702","1-1801","1-1802","1-1901","1-1902","1-2001","1-2002","1-2101","1-2102",
            "1-2201","1-2202","1-2301","1-2302","1-2401","1-2402",
            "3-101","3-201","3-202","3-301","3-302","3-401","3-402","3-501","3-502","3-601",
            "3-602","3-701","3-702","3-801","3-802","3-901","3-902","3-1001","3-1002","3-1101",
            "3-1102","3-1201","3-1202","3-1301","3-1302","3-1401","3-1402","3-1501","3-1502","3-1601",
            "3-1602","3-1701","3-1702","3-1801","3-1802","3-1901","3-1902","3-2001","3-2002","3-2101",
            "3-2102","3-2201","3-2202","3-2301","3-2302","3-2401","3-2402","3-2501","3-2502",
            "4-1-101","4-1-102","4-1-201","4-1-202","4-1-301","4-1-302","4-1-401","4-1-402","4-1-501",
            "4-1-502","4-1-601","4-1-602","4-1-701","4-1-702","4-1-801","4-1-802","4-1-901","4-1-902",
            "4-1-1001","4-1-1002","4-1-1101","4-1-1102","4-1-1201","4-1-1202","4-1-1301","4-1-1302",
            "4-1-1401","4-1-1402","4-1-1501","4-1-1502","4-1-1601","4-1-1602","4-1-1701","4-1-1702",
            "4-1-1801","4-1-1802","4-1-1901","4-1-1902","4-1-2001","4-1-2002","4-1-2101","4-1-2102",
            "4-1-2201","4-1-2202","4-1-2301","4-1-2302","4-1-2401","4-1-2402","4-1-2501","4-1-2502",
            "4-1-2601","4-1-2602","4-1-2701","4-1-2702",
            "4-2-101","4-2-102","4-2-201","4-2-202","4-2-301","4-2-302","4-2-401","4-2-402","4-2-501",
            "4-2-502","4-2-601","4-2-602","4-2-701","4-2-702","4-2-801","4-2-802","4-2-901","4-2-902",
            "4-2-1001","4-2-1002","4-2-1101","4-2-1102","4-2-1201","4-2-1202","4-2-1301","4-2-1302",
            "4-2-1401","4-2-1402","4-2-1501","4-2-1502","4-2-1601","4-2-1602","4-2-1701","4-2-1702",
            "4-2-1801","4-2-1802","4-2-1901","4-2-1902","4-2-2001","4-2-2002","4-2-2101","4-2-2102",
            "4-2-2201","4-2-2202","4-2-2301","4-2-2302","4-2-2401","4-2-2402","4-2-2501","4-2-2502",
            "4-2-2601","4-2-2602","4-2-2701","4-2-2702",
            "5-1-101","5-1-102","5-1-201","5-1-202","5-1-301","5-1-302","5-1-401","5-1-402","5-1-501",
            "5-1-502","5-1-601","5-1-602","5-1-701","5-1-702","5-1-801","5-1-802","5-1-901","5-1-902",
            "5-1-1001","5-1-1002","5-1-1101","5-1-1102","5-1-1201","5-1-1202","5-1-1301","5-1-1302",
            "5-1-1401","5-1-1402","5-1-1501","5-1-1502","5-1-1601","5-1-1602","5-1-1701","5-1-1702",
            "5-1-1801","5-1-1802","5-1-1901","5-1-1902","5-1-2001","5-1-2002","5-1-2101","5-1-2102",
            "5-1-2201","5-1-2202","5-1-2301","5-1-2302","5-1-2401","5-1-2402","5-1-2501","5-1-2502",
            "5-1-2601","5-1-2602","5-1-2701","5-1-2702",
            "5-2-101","5-2-102","5-2-201","5-2-202","5-2-301","5-2-302","5-2-401","5-2-402","5-2-501",
            "5-2-502","5-2-601","5-2-602","5-2-701","5-2-702","5-2-801","5-2-802","5-2-901","5-2-902",
            "5-2-1001","5-2-1002","5-2-1101","5-2-1102","5-2-1201","5-2-1202","5-2-1301","5-2-1302",
            "5-2-1401","5-2-1402","5-2-1501","5-2-1502","5-2-1601","5-2-1602","5-2-1701","5-2-1702",
            "5-2-1801","5-2-1802","5-2-1901","5-2-1902","5-2-2001","5-2-2002","5-2-2101","5-2-2102",
            "5-2-2201","5-2-2202","5-2-2301","5-2-2302","5-2-2401","5-2-2402","5-2-2501","5-2-2502",
            "5-2-2601","5-2-2602","5-2-2701","5-2-2702",
            "6-201","6-202","6-301","6-302","6-401","6-402","6-501","6-502","6-601","6-602",
            "6-701","6-702","6-801","6-802","6-901","6-902","6-1001","6-1002","6-1101","6-1102",
            "6-1201","6-1202","6-1301","6-1302","6-1401","6-1402","6-1501","6-1502","6-1601","6-1602",
            "6-1701","6-1702","6-1801","6-1802","6-1901","6-1902","6-2001","6-2002","6-2101","6-2102",
            "6-2201","6-2202","6-2301","6-2302","6-2401","6-2402","6-2501","6-2502","6-2601","6-2602",
            "7-101","7-102","7-103","7-104","7-201","7-202","7-203","7-204","7-301","7-302",
            "7-303","7-304","7-401","7-402","7-403","7-404","7-501","7-502","7-503","7-504",
            "7-601","7-602","7-603","7-604","7-701","7-702","7-703","7-704","7-801","7-802",
            "7-803","7-804","7-901","7-902","7-903","7-904","7-1001"
        ];

        // åˆå§‹åŒ–æŠ•ç¥¨æ•°æ®
        let votes = JSON.parse(localStorage.getItem('balconyVotes')) || {};
        let currentHouse = '';
        let selectedOption = -1;

        // é¡µé¢åŠ è½½æ—¶ç”ŸæˆäºŒç»´ç 
        document.addEventListener('DOMContentLoaded', function() {
            generateQRCode();
        });

        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode() {
            const qrCodeElement = document.getElementById('qrCode');
            qrCodeElement.innerHTML = '';
            
            // ä½¿ç”¨qrcode.jsç”ŸæˆäºŒç»´ç 
            const url = window.location.href;
            new QRCode(qrCodeElement, {
                text: url,
                width: 160,
                height: 160,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // åˆ†äº«åˆ°å¾®ä¿¡
        function shareToWechat() {
            // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡æµè§ˆå™¨ä¸­
            const isWechat = /MicroMessenger/i.test(navigator.userAgent);
            
            if (isWechat) {
                // åœ¨å¾®ä¿¡ä¸­ï¼Œä½¿ç”¨å¾®ä¿¡çš„åˆ†äº«API
                if (typeof WeixinJSBridge !== 'undefined') {
                    WeixinJSBridge.invoke('shareTimeline', {
                        title: 'å°åŒºåŒ…é˜³å°æ–¹æ¡ˆæŠ•ç¥¨',
                        desc: 'è¯·å‚ä¸å°åŒºåŒ…é˜³å°æ–¹æ¡ˆæŠ•ç¥¨ï¼Œæ¯æˆ·ä¸€ç¥¨',
                        link: window.location.href,
                        imgUrl: window.location.origin + '/favicon.ico'
                    });
                } else {
                    // å¦‚æœå¾®ä¿¡APIä¸å¯ç”¨ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨åˆ†äº«
                    alert('è¯·ç‚¹å‡»å³ä¸Šè§’èœå•ï¼Œé€‰æ‹©"åˆ†äº«åˆ°æœ‹å‹åœˆ"æˆ–"å‘é€ç»™æœ‹å‹"');
                }
            } else {
                // ä¸åœ¨å¾®ä¿¡ä¸­ï¼Œæç¤ºç”¨æˆ·
                alert('è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€æ­¤é¡µé¢è¿›è¡Œåˆ†äº«ï¼Œæˆ–ä½¿ç”¨"å¤åˆ¶é“¾æ¥"åŠŸèƒ½');
            }
        }

        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const url = window.location.href;
            
            // å°è¯•ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„å¤åˆ¶API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·å°†é“¾æ¥å‘é€åˆ°å¾®ä¿¡ç¾¤ï¼Œå…¶ä»–ä¸šä¸»ç‚¹å‡»é“¾æ¥å³å¯å‚ä¸æŠ•ç¥¨ã€‚');
                }).catch(() => {
                    fallbackCopyTextToClipboard(url);
                });
            } else {
                fallbackCopyTextToClipboard(url);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·å°†é“¾æ¥å‘é€åˆ°å¾®ä¿¡ç¾¤ï¼Œå…¶ä»–ä¸šä¸»ç‚¹å‡»é“¾æ¥å³å¯å‚ä¸æŠ•ç¥¨ã€‚');
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š\n\n' + text);
                }
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š\n\n' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // æ­¥éª¤åˆ‡æ¢å‡½æ•°
        function showStep(step) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        // é—¨ç‰Œå·éªŒè¯
        function verifyHouse() {
            const input = document.getElementById('houseInput').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            
            if (validHouses.includes(input)) {
                currentHouse = input;
                errorMsg.style.display = 'none';
                
                // æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
                if (votes[currentHouse]) {
                    showStep(3);
                    const options = ['åŒæ„', 'åå¯¹', 'å¼ƒæƒ'];
                    document.getElementById('voteResult').textContent = 
                        `æ‚¨çš„é€‰æ‹©ï¼š${options[votes[currentHouse].choice]}`;
                } else {
                    showStep(2);
                }
            } else {
                errorMsg.style.display = 'block';
                errorMsg.textContent = 'é—¨ç‰Œå·æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥';
            }
        }

        // é€‰é¡¹é€‰æ‹©
        function selectOption(option) {
            selectedOption = option;
            document.querySelectorAll('.option').forEach((el, idx) => {
                if (idx === option) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        // æäº¤æŠ•ç¥¨
        function submitVote() {
            if (selectedOption === -1) {
                alert('è¯·é€‰æ‹©æŠ•ç¥¨é€‰é¡¹');
                return;
            }
            
            // è®°å½•æŠ•ç¥¨ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
            votes[currentHouse] = {
                choice: selectedOption,
                timestamp: Math.floor(Date.now() / 1000)
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('balconyVotes', JSON.stringify(votes));
            showStep(3);
            
            // æ˜¾ç¤ºç”¨æˆ·é€‰æ‹©
            const options = ['åŒæ„', 'åå¯¹', 'å¼ƒæƒ'];
            document.getElementById('voteResult').textContent = 
                `æ‚¨çš„é€‰æ‹©ï¼š${options[selectedOption]}`;
        }

        // ç®¡ç†å‘˜åŠŸèƒ½
        function showAdmin() {
            document.getElementById('adminPanel').style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        }

        function loadStats() {
            // ç®€å•å¯†ç éªŒè¯
            if (document.getElementById('adminPass').value !== 'admin123') {
                alert('ç®¡ç†å‘˜å¯†ç é”™è¯¯');
                return;
            }
            
            const stats = document.getElementById('stats');
            stats.style.display = 'block';
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const total = validHouses.length;
            const voted = Object.keys(votes).length;
            const ratio = total > 0 ? ((voted / total) * 100).toFixed(1) : 0;
            
            // æŒ‰é€‰é¡¹ç»Ÿè®¡
            let agree = 0, disagree = 0, abstain = 0;
            Object.values(votes).forEach(vote => {
                if (vote.choice === 0) agree++;
                if (vote.choice === 1) disagree++;
                if (vote.choice === 2) abstain++;
            });
            
            // æ›´æ–°UI
            document.getElementById('totalHouses').textContent = total;
            document.getElementById('votedHouses').textContent = voted;
            document.getElementById('voteRatio').textContent = ratio + '%';
            
            document.getElementById('agreeCount').textContent = agree;
            document.getElementById('disagreeCount').textContent = disagree;
            document.getElementById('abstainCount').textContent = abstain;
            
            const agreePercent = voted ? ((agree / voted) * 100).toFixed(1) : 0;
            const disagreePercent = voted ? ((disagree / voted) * 100).toFixed(1) : 0;
            const abstainPercent = voted ? ((abstain / voted) * 100).toFixed(1) : 0;
            
            document.getElementById('agreePercent').textContent = agreePercent + '%';
            document.getElementById('disagreePercent').textContent = disagreePercent + '%';
            document.getElementById('abstainPercent').textContent = abstainPercent + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            document.querySelector('#agreeStats .fill').style.width = agreePercent + '%';
            document.querySelector('#disagreeStats .fill').style.width = disagreePercent + '%';
            document.querySelector('#abstainStats .fill').style.width = abstainPercent + '%';
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            const resultEl = document.getElementById('finalResult');
            if (agree > disagree) {
                resultEl.textContent = 'âœ… æ–¹æ¡ˆé€šè¿‡ï¼ˆåŒæ„ç¥¨æ•°è¶…è¿‡åå¯¹ç¥¨æ•°ï¼‰';
                resultEl.style.color = '#27ae60';
            } else if (disagree > agree) {
                resultEl.textContent = 'âŒ æ–¹æ¡ˆæœªé€šè¿‡ï¼ˆåå¯¹ç¥¨æ•°è¶…è¿‡åŒæ„ç¥¨æ•°ï¼‰';
                resultEl.style.color = '#e74c3c';
            } else if (agree === 0 && disagree === 0) {
                resultEl.textContent = 'â³ æš‚æ— æŠ•ç¥¨æ•°æ®';
                resultEl.style.color = '#7f8c8d';
            } else {
                resultEl.textContent = 'âš–ï¸ æŠ•ç¥¨å¹³å±€ï¼ˆéœ€è¿›ä¸€æ­¥è®¨è®ºï¼‰';
                resultEl.style.color = '#f39c12';
            }
        }

        function exportData() {
            const dataStr = JSON.stringify({
                houses: validHouses,
                votes: votes,
                timestamp: new Date().toISOString(),
                total: validHouses.length
            }, null, 2);
            
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `åŒ…é˜³å°æŠ•ç¥¨æ•°æ®_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function resetVotes() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ•ç¥¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('balconyVotes');
                votes = {};
                alert('æŠ•ç¥¨æ•°æ®å·²é‡ç½®');
                if (document.getElementById('stats').style.display === 'block') {
                    loadStats();
                }
            }
        }
        
        function resetSingleVote() {
            const houseToReset = document.getElementById('resetHouseInput').value.trim();
            if (!houseToReset) {
                alert('è¯·è¾“å…¥è¦é‡ç½®çš„é—¨ç‰Œå·');
                return;
            }
            
            if (!validHouses.includes(houseToReset)) {
                alert('æ— æ•ˆçš„é—¨ç‰Œå·');
                return;
            }
            
            if (votes[houseToReset]) {
                delete votes[houseToReset];
                localStorage.setItem('balconyVotes', JSON.stringify(votes));
                alert(`å·²é‡ç½® ${houseToReset} çš„æŠ•ç¥¨æ•°æ®`);
                
                if (document.getElementById('stats').style.display === 'block') {
                    loadStats();
                }
            } else {
                alert('è¯¥é—¨ç‰Œå·å°šæœªæŠ•ç¥¨');
            }
        }
    </script>
</body>
</html>